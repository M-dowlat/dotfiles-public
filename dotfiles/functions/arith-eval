#!/usr/bin/env zsh

local _arith_eval=${(j: :)@}

# Remove commas.
() {
  emulate -L zsh -o extended_glob
  while true; do
    local match=() mbegin=() mend=()
    _arith_eval=${_arith_eval//(#b)([0-9]),([0-9][0-9][0-9])/$match[1]$match[2]}
    (( $#match )) || break
  done
} "$@"

# Do the math carefully: respect user options and avoid shadowing parameters.
printf -v _arith_eval '%.13g' _arith_eval || return

emulate -L zsh -o extended_glob
local match mbegin mend x

# Add commas.
while true; do
  x=${_arith_eval/#(#b)(|-)([0-9]##)([0-9][0-9][0-9])(|[,.eE])/$match[1]$match[2],$match[3]$match[4]}
  [[ $x == $_arith_eval ]] && break
  _arith_eval=$x
done

print -r -- $_arith_eval
